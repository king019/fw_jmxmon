<!DOCTYPE html>
<html>
<head>
  <title>LocalVirtualMachine.java</title>
  <meta http-equiv='Content-Type' content='text/html; charset=UTF-8'/>
  <link rel='stylesheet' type='text/css' href='../../../../../coverage.css'/>
  <link rel='shortcut icon' type='image/png' href='../../../../../logo.png'/>
  <script type='text/javascript' src='../../../../../coverage.js'></script>
  <script type='text/javascript' src='../../../../../prettify.js'></script>
</head>
<body onload='prettyPrint()'>
  <table cellpadding='0' cellspacing='1'>
    <caption>jmxmon/src/main/java/com/stephan/tof/jmxmon/jmxutil/LocalVirtualMachine.java</caption>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td class='comment' onclick='showHideLines(this)'><div>/*
 * %W% %E%
 *
 * Copyright (c) 2006, Oracle and/or its affiliates. All rights reserved.
 * ORACLE PROPRIETARY/CONFIDENTIAL. Use is subject to license terms.
 */</div><span>/*...*/</span></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>8</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>package com.stephan.tof.jmxmon.jmxutil;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td><pre class='imports prettyprint' onclick='showHideLines(this)'><div>import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Properties;
import java.util.Set;

import sun.jvmstat.monitor.HostIdentifier;
import sun.jvmstat.monitor.MonitorException;
import sun.jvmstat.monitor.MonitoredHost;
import sun.jvmstat.monitor.MonitoredVm;
import sun.jvmstat.monitor.MonitoredVmUtil;
import sun.jvmstat.monitor.VmIdentifier;</div><span>import ...</span></pre></td>
    </tr>
    <tr>
      <td class='line'>24</td><td>&nbsp;</td>
      <td><pre class='comment'>// Sun private</pre></td>
    </tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td><pre class='imports prettyprint' onclick='showHideLines(this)'><div>import sun.management.ConnectorAddressLink;

import com.sun.tools.attach.AgentInitializationException;
import com.sun.tools.attach.AgentLoadException;
import com.sun.tools.attach.AttachNotSupportedException;</div><span>import ...</span></pre></td>
    </tr>
    <tr>
      <td class='line'>30</td><td>&nbsp;</td>
      <td><pre class='comment'>// Sun specific</pre></td>
    </tr>
    <tr>
      <td class='line'></td><td>&nbsp;</td>
      <td><pre class='imports prettyprint' onclick='showHideLines(this)'><div>import com.sun.tools.attach.VirtualMachine;
import com.sun.tools.attach.VirtualMachineDescriptor;
</div><span>import ...</span></pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>34</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>public class LocalVirtualMachine {</pre></td>
    </tr>
    <tr>
      <td class='line'>35</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private String address;</pre></td>
    </tr>
    <tr>
      <td class='line'>36</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private String commandLine;</pre></td>
    </tr>
    <tr>
      <td class='line'>37</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private String displayName;</pre></td>
    </tr>
    <tr>
      <td class='line'>38</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private int vmid;</pre></td>
    </tr>
    <tr>
      <td class='line'>39</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private boolean isAttachSupported;</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>41</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public LocalVirtualMachine(int vmid, String commandLine, boolean canAttach, String connectorAddress) {</pre></td>
    </tr>
    <tr>
      <td class='line'>42</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.vmid = vmid;</pre></td>
    </tr>
    <tr>
      <td class='line'>43</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.commandLine = commandLine;</pre></td>
    </tr>
    <tr>
      <td class='line'>44</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.address = connectorAddress;</pre></td>
    </tr>
    <tr>
      <td class='line'>45</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.isAttachSupported = canAttach; </pre></td>
    </tr>
    <tr>
      <td class='line'>46</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        this.displayName = getDisplayName(commandLine);</pre></td>
    </tr>
    <tr>
      <td class='line'>47</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>49</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private static String getDisplayName(String commandLine) {</pre></td>
    </tr>
    <tr>
      <td class='line'>50</td><td>&nbsp;</td>
      <td><pre class='comment'>        // trim the pathname of jar file if it's a jar</pre></td>
    </tr>
    <tr>
      <td class='line'>51</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        String[] res = commandLine.split(" ", 2);</pre></td>
    </tr>
    <tr>
      <td class='line'>52</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (res[0].endsWith(".jar")) {</pre></td>
    </tr>
    <tr>
      <td class='line'>53</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>           File jarfile = new File(res[0]);</pre></td>
    </tr>
    <tr>
      <td class='line'>54</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>           String displayName = jarfile.getName();</pre></td>
    </tr>
    <tr>
      <td class='line'>55</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>           if (res.length == 2) { </pre></td>
    </tr>
    <tr>
      <td class='line'>56</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>               displayName += " " + res[1];</pre></td>
    </tr>
    <tr>
      <td class='line'>57</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>           }</pre></td>
    </tr>
    <tr>
      <td class='line'>58</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>           return displayName;</pre></td>
    </tr>
    <tr>
      <td class='line'>59</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } </pre></td>
    </tr>
    <tr>
      <td class='line'>60</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return commandLine;</pre></td>
    </tr>
    <tr>
      <td class='line'>61</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>63</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public int vmid() {</pre></td>
    </tr>
    <tr>
      <td class='line'>64</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return vmid;</pre></td>
    </tr>
    <tr>
      <td class='line'>65</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>67</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public boolean isManageable() {</pre></td>
    </tr>
    <tr>
      <td class='line'>68</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return (address != null);</pre></td>
    </tr>
    <tr>
      <td class='line'>69</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>71</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public boolean isAttachable() {</pre></td>
    </tr>
    <tr>
      <td class='line'>72</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return isAttachSupported;</pre></td>
    </tr>
    <tr>
      <td class='line'>73</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>75</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public void startManagementAgent() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>76</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (address != null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>77</td><td>&nbsp;</td>
      <td><pre class='comment'>            // already started</pre></td>
    </tr>
    <tr>
      <td class='line'>78</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            return;</pre></td>
    </tr>
    <tr>
      <td class='line'>79</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>81</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!isAttachable()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>82</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw new IOException("This virtual machine \"" + vmid +</pre></td>
    </tr>
    <tr>
      <td class='line'>83</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                "\" does not support dynamic attach.");</pre></td>
    </tr>
    <tr>
      <td class='line'>84</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>86</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        loadManagementAgent();</pre></td>
    </tr>
    <tr>
      <td class='line'>87</td><td>&nbsp;</td>
      <td><pre class='comment'>        // fails to load or start the management agent</pre></td>
    </tr>
    <tr>
      <td class='line'>88</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (address == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>89</td><td>&nbsp;</td>
      <td><pre class='comment'>            // should never reach here</pre></td>
    </tr>
    <tr>
      <td class='line'>90</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw new IOException("Fails to find connector address");</pre></td>
    </tr>
    <tr>
      <td class='line'>91</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>92</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>94</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public String connectorAddress() {</pre></td>
    </tr>
    <tr>
      <td class='line'>95</td><td>&nbsp;</td>
      <td><pre class='comment'>        // return null if not available or no JMX agent</pre></td>
    </tr>
    <tr>
      <td class='line'>96</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return address;</pre></td>
    </tr>
    <tr>
      <td class='line'>97</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>99</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public String displayName() {</pre></td>
    </tr>
    <tr>
      <td class='line'>100</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return displayName;</pre></td>
    </tr>
    <tr>
      <td class='line'>101</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>103</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public String toString() {</pre></td>
    </tr>
    <tr>
      <td class='line'>104</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return commandLine;</pre></td>
    </tr>
    <tr>
      <td class='line'>105</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>107</td><td>&nbsp;</td>
      <td><pre class='comment'>    // This method returns the list of all virtual machines currently </pre></td>
    </tr>
    <tr>
      <td class='line'>108</td><td>&nbsp;</td>
      <td><pre class='comment'>    // running on the machine </pre></td>
    </tr>
    <tr>
      <td class='line'>109</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public static Map&lt;Integer, LocalVirtualMachine> getAllVirtualMachines() {</pre></td>
    </tr>
    <tr>
      <td class='line'>110</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Map&lt;Integer, LocalVirtualMachine> map = </pre></td>
    </tr>
    <tr>
      <td class='line'>111</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            new HashMap&lt;Integer, LocalVirtualMachine>();</pre></td>
    </tr>
    <tr>
      <td class='line'>112</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        getMonitoredVMs(map);</pre></td>
    </tr>
    <tr>
      <td class='line'>113</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        getAttachableVMs(map);</pre></td>
    </tr>
    <tr>
      <td class='line'>114</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return map;</pre></td>
    </tr>
    <tr>
      <td class='line'>115</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>117</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private static void getMonitoredVMs(Map&lt;Integer, LocalVirtualMachine> map) {</pre></td>
    </tr>
    <tr>
      <td class='line'>118</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        MonitoredHost host;</pre></td>
    </tr>
    <tr>
      <td class='line'>119</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Set vms;</pre></td>
    </tr>
    <tr>
      <td class='line'>120</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>121</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            host = MonitoredHost.getMonitoredHost(new HostIdentifier((String)null));</pre></td>
    </tr>
    <tr>
      <td class='line'>122</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            vms = host.activeVms();</pre></td>
    </tr>
    <tr>
      <td class='line'>123</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (java.net.URISyntaxException sx) {</pre></td>
    </tr>
    <tr>
      <td class='line'>124</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw new InternalError(sx.getMessage());</pre></td>
    </tr>
    <tr>
      <td class='line'>125</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (MonitorException mx) {</pre></td>
    </tr>
    <tr>
      <td class='line'>126</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw new InternalError(mx.getMessage());</pre></td>
    </tr>
    <tr>
      <td class='line'>127</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>128</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        for (Object vmid: vms) {</pre></td>
    </tr>
    <tr>
      <td class='line'>129</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (vmid instanceof Integer) {</pre></td>
    </tr>
    <tr>
      <td class='line'>130</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                int pid = ((Integer) vmid).intValue();</pre></td>
    </tr>
    <tr>
      <td class='line'>131</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                String name = vmid.toString(); // default to pid if name not available</pre></td>
    </tr>
    <tr>
      <td class='line'>132</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                boolean attachable = false;</pre></td>
    </tr>
    <tr>
      <td class='line'>133</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                String address = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>134</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                try {</pre></td>
    </tr>
    <tr>
      <td class='line'>135</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                     MonitoredVm mvm = host.getMonitoredVm(new VmIdentifier(name));</pre></td>
    </tr>
    <tr>
      <td class='line'>136</td><td>&nbsp;</td>
      <td><pre class='comment'>                     // use the command line as the display name</pre></td>
    </tr>
    <tr>
      <td class='line'>137</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                     name =  MonitoredVmUtil.commandLine(mvm);</pre></td>
    </tr>
    <tr>
      <td class='line'>138</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                     attachable = MonitoredVmUtil.isAttachable(mvm);</pre></td>
    </tr>
    <tr>
      <td class='line'>139</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                     address = ConnectorAddressLink.importFrom(pid);</pre></td>
    </tr>
    <tr>
      <td class='line'>140</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                     mvm.detach();</pre></td>
    </tr>
    <tr>
      <td class='line'>141</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                } catch (Exception x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>142</td><td>&nbsp;</td>
      <td><pre class='comment'>                     // ignore</pre></td>
    </tr>
    <tr>
      <td class='line'>143</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                }</pre></td>
    </tr>
    <tr>
      <td class='line'>144</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                map.put((Integer) vmid, </pre></td>
    </tr>
    <tr>
      <td class='line'>145</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        new LocalVirtualMachine(pid, name, attachable, address));</pre></td>
    </tr>
    <tr>
      <td class='line'>146</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>147</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>148</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>150</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private static final String LOCAL_CONNECTOR_ADDRESS_PROP =</pre></td>
    </tr>
    <tr>
      <td class='line'>151</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        "com.sun.management.jmxremote.localConnectorAddress";</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>153</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private static void getAttachableVMs(Map&lt;Integer, LocalVirtualMachine> map) {</pre></td>
    </tr>
    <tr>
      <td class='line'>154</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        List&lt;VirtualMachineDescriptor> vms = VirtualMachine.list();</pre></td>
    </tr>
    <tr>
      <td class='line'>155</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        for (VirtualMachineDescriptor vmd : vms) {</pre></td>
    </tr>
    <tr>
      <td class='line'>156</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>157</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                Integer vmid = Integer.valueOf(vmd.id());</pre></td>
    </tr>
    <tr>
      <td class='line'>158</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                if (!map.containsKey(vmid)) {</pre></td>
    </tr>
    <tr>
      <td class='line'>159</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    boolean attachable = false;</pre></td>
    </tr>
    <tr>
      <td class='line'>160</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    String address = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>161</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    try {</pre></td>
    </tr>
    <tr>
      <td class='line'>162</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        VirtualMachine vm = VirtualMachine.attach(vmd);</pre></td>
    </tr>
    <tr>
      <td class='line'>163</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        attachable = true;</pre></td>
    </tr>
    <tr>
      <td class='line'>164</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        Properties agentProps = vm.getAgentProperties();</pre></td>
    </tr>
    <tr>
      <td class='line'>165</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        address = (String) agentProps.get(LOCAL_CONNECTOR_ADDRESS_PROP);</pre></td>
    </tr>
    <tr>
      <td class='line'>166</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        vm.detach();</pre></td>
    </tr>
    <tr>
      <td class='line'>167</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    } catch (AttachNotSupportedException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>168</td><td>&nbsp;</td>
      <td><pre class='comment'>                        // not attachable</pre></td>
    </tr>
    <tr>
      <td class='line'>169</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    } catch (IOException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>170</td><td>&nbsp;</td>
      <td><pre class='comment'>                        // ignore </pre></td>
    </tr>
    <tr>
      <td class='line'>171</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    }</pre></td>
    </tr>
    <tr>
      <td class='line'>172</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                    map.put(vmid, new LocalVirtualMachine(vmid.intValue(),</pre></td>
    </tr>
    <tr>
      <td class='line'>173</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                                                          vmd.displayName(),</pre></td>
    </tr>
    <tr>
      <td class='line'>174</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                                                          attachable,</pre></td>
    </tr>
    <tr>
      <td class='line'>175</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                                                          address));</pre></td>
    </tr>
    <tr>
      <td class='line'>176</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                }</pre></td>
    </tr>
    <tr>
      <td class='line'>177</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (NumberFormatException e) {</pre></td>
    </tr>
    <tr>
      <td class='line'>178</td><td>&nbsp;</td>
      <td><pre class='comment'>                // do not support vmid different than pid </pre></td>
    </tr>
    <tr>
      <td class='line'>179</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>180</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>181</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>183</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    public static LocalVirtualMachine getLocalVirtualMachine(int vmid) {</pre></td>
    </tr>
    <tr>
      <td class='line'>184</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Map&lt;Integer, LocalVirtualMachine> map = getAllVirtualMachines();</pre></td>
    </tr>
    <tr>
      <td class='line'>185</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        LocalVirtualMachine lvm = map.get(vmid);</pre></td>
    </tr>
    <tr>
      <td class='line'>186</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (lvm == null) {</pre></td>
    </tr>
    <tr>
      <td class='line'>187</td><td>&nbsp;</td>
      <td><pre class='comment'>            // Check if the VM is attachable but not included in the list</pre></td>
    </tr>
    <tr>
      <td class='line'>188</td><td>&nbsp;</td>
      <td><pre class='comment'>            // if it's running with a different security context.</pre></td>
    </tr>
    <tr>
      <td class='line'>189</td><td>&nbsp;</td>
      <td><pre class='comment'>            // For example, Windows services running</pre></td>
    </tr>
    <tr>
      <td class='line'>190</td><td>&nbsp;</td>
      <td><pre class='comment'>            // local SYSTEM account are attachable if you have Adminstrator</pre></td>
    </tr>
    <tr>
      <td class='line'>191</td><td>&nbsp;</td>
      <td><pre class='comment'>            // privileges. </pre></td>
    </tr>
    <tr>
      <td class='line'>192</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            boolean attachable = false;</pre></td>
    </tr>
    <tr>
      <td class='line'>193</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            String address = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>194</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            String name = String.valueOf(vmid); // default display name to pid </pre></td>
    </tr>
    <tr>
      <td class='line'>195</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            try {</pre></td>
    </tr>
    <tr>
      <td class='line'>196</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                VirtualMachine vm = VirtualMachine.attach(name);</pre></td>
    </tr>
    <tr>
      <td class='line'>197</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                attachable = true;</pre></td>
    </tr>
    <tr>
      <td class='line'>198</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                Properties agentProps = vm.getAgentProperties();</pre></td>
    </tr>
    <tr>
      <td class='line'>199</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                address = (String) agentProps.get(LOCAL_CONNECTOR_ADDRESS_PROP);</pre></td>
    </tr>
    <tr>
      <td class='line'>200</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                vm.detach();</pre></td>
    </tr>
    <tr>
      <td class='line'>201</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                lvm = new LocalVirtualMachine(vmid, name, attachable, address);</pre></td>
    </tr>
    <tr>
      <td class='line'>202</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (AttachNotSupportedException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>203</td><td>&nbsp;</td>
      <td><pre class='comment'>                // not attachable</pre></td>
    </tr>
    <tr>
      <td class='line'>204</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                throw new IllegalStateException(x);</pre></td>
    </tr>
    <tr>
      <td class='line'>205</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            } catch (IOException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>206</td><td>&nbsp;</td>
      <td><pre class='comment'>                // ignore </pre></td>
    </tr>
    <tr>
      <td class='line'>207</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            	throw new IllegalStateException(x);</pre></td>
    </tr>
    <tr>
      <td class='line'>208</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>209</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr>
      <td class='line'>210</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        return lvm;</pre></td>
    </tr>
    <tr>
      <td class='line'>211</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>213</td><td>&nbsp;</td>
      <td><pre class='comment'>    // load the management agent into the target VM</pre></td>
    </tr>
    <tr>
      <td class='line'>214</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    private void loadManagementAgent() throws IOException {</pre></td>
    </tr>
    <tr>
      <td class='line'>215</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        VirtualMachine vm = null;</pre></td>
    </tr>
    <tr>
      <td class='line'>216</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        String name = String.valueOf(vmid);</pre></td>
    </tr>
    <tr>
      <td class='line'>217</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>218</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            vm = VirtualMachine.attach(name);</pre></td>
    </tr>
    <tr>
      <td class='line'>219</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (AttachNotSupportedException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>220</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            IOException ioe = new IOException(x.getMessage());</pre></td>
    </tr>
    <tr>
      <td class='line'>221</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            ioe.initCause(x);</pre></td>
    </tr>
    <tr>
      <td class='line'>222</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw ioe;</pre></td>
    </tr>
    <tr>
      <td class='line'>223</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>225</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        String home = vm.getSystemProperties().getProperty("java.home");</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>227</td><td>&nbsp;</td>
      <td><pre class='comment'>        // Normally in ${java.home}/jre/lib/management-agent.jar but might</pre></td>
    </tr>
    <tr>
      <td class='line'>228</td><td>&nbsp;</td>
      <td><pre class='comment'>        // be in ${java.home}/lib in build environments.</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>230</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        String agent = home + File.separator + "jre" + File.separator + </pre></td>
    </tr>
    <tr>
      <td class='line'>231</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                           "lib" + File.separator + "management-agent.jar";</pre></td>
    </tr>
    <tr>
      <td class='line'>232</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        File f = new File(agent);</pre></td>
    </tr>
    <tr>
      <td class='line'>233</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        if (!f.exists()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>234</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            agent = home + File.separator +  "lib" + File.separator +</pre></td>
    </tr>
    <tr>
      <td class='line'>235</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                        "management-agent.jar";</pre></td>
    </tr>
    <tr>
      <td class='line'>236</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            f = new File(agent);</pre></td>
    </tr>
    <tr>
      <td class='line'>237</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            if (!f.exists()) {</pre></td>
    </tr>
    <tr>
      <td class='line'>238</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>                throw new IOException("Management agent not found");</pre></td>
    </tr>
    <tr>
      <td class='line'>239</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            }</pre></td>
    </tr>
    <tr>
      <td class='line'>240</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>242</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        agent = f.getCanonicalPath();</pre></td>
    </tr>
    <tr>
      <td class='line'>243</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        try {</pre></td>
    </tr>
    <tr>
      <td class='line'>244</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            vm.loadAgent(agent, "com.sun.management.jmxremote");</pre></td>
    </tr>
    <tr>
      <td class='line'>245</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (AgentLoadException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>246</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            IOException ioe = new IOException(x.getMessage());</pre></td>
    </tr>
    <tr>
      <td class='line'>247</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            ioe.initCause(x);</pre></td>
    </tr>
    <tr>
      <td class='line'>248</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw ioe;</pre></td>
    </tr>
    <tr>
      <td class='line'>249</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        } catch (AgentInitializationException x) {</pre></td>
    </tr>
    <tr>
      <td class='line'>250</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            IOException ioe = new IOException(x.getMessage());</pre></td>
    </tr>
    <tr>
      <td class='line'>251</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            ioe.initCause(x);</pre></td>
    </tr>
    <tr>
      <td class='line'>252</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>            throw ioe;</pre></td>
    </tr>
    <tr>
      <td class='line'>253</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        }</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>255</td><td>&nbsp;</td>
      <td><pre class='comment'>        // get the connector address</pre></td>
    </tr>
    <tr>
      <td class='line'>256</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        Properties agentProps = vm.getAgentProperties();</pre></td>
    </tr>
    <tr>
      <td class='line'>257</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        address = (String) agentProps.get(LOCAL_CONNECTOR_ADDRESS_PROP);</pre></td>
    </tr>
    <tr><td class='line'></td><td colspan='2'>&nbsp;</td></tr>
    <tr>
      <td class='line'>259</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>        vm.detach();</pre></td>
    </tr>
    <tr>
      <td class='line'>260</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>    }</pre></td>
    </tr>
    <tr>
      <td class='line'>261</td><td>&nbsp;</td>
      <td><pre class='prettyprint'>}</pre></td>
    </tr>
  </table>
</body>
</html>
